# Test Dockerfile for AMD64 package verification
ARG TARGETPLATFORM=linux/amd64
FROM ubuntu:latest

# Update package list and install dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    file \
    && rm -rf /var/lib/apt/lists/*

# Copy the AMD64 .deb package into the container
ARG VERSION=1.0.0
COPY .build/packages/ocuroot_${VERSION}_amd64.deb /tmp/ocuroot.deb

# Install the package
RUN dpkg -i /tmp/ocuroot.deb || (apt-get update && apt-get install -f -y && dpkg -i /tmp/ocuroot.deb)

# Verify installation and run tests
RUN set -e && \
    echo "=== Package Installation Tests ===" && \
    dpkg -l | grep ocuroot && \
    echo "✓ Package is installed" && \
    \
    echo "=== Binary Tests ===" && \
    ls -la /usr/bin/ocuroot && \
    file /usr/bin/ocuroot && \
    echo "✓ Binary exists and is executable" && \
    \
    echo "=== Architecture Tests ===" && \
    file /usr/bin/ocuroot | grep "x86-64" && \
    echo "✓ Binary is correct architecture (x86-64)" && \
    \
    echo "=== Functionality Tests ===" && \
    ocuroot --help > /dev/null && \
    echo "✓ Help command works" && \
    ocuroot version > /dev/null && \
    echo "✓ Version command works" && \
    \
    echo "=== Package Metadata Tests ===" && \
    PACKAGE_VERSION=$(dpkg -s ocuroot | grep '^Version:' | cut -d' ' -f2) && \
    echo "Package version: $PACKAGE_VERSION" && \
    EXPECTED_PACKAGE_VERSION=$(echo "${VERSION}" | cut -d'-' -f1) && \
    echo "Expected package version: $EXPECTED_PACKAGE_VERSION" && \
    [ "$PACKAGE_VERSION" = "$EXPECTED_PACKAGE_VERSION" ] && \
    echo "✓ Package version matches expected version" && \
    \
    echo "=== All tests passed! ==="

# Clean up
RUN rm /tmp/ocuroot.deb

WORKDIR /root
CMD ["/bin/bash"]
